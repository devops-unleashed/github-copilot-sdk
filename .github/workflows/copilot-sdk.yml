name: Copilot SDK Workflow Monitor

on:
  workflow_dispatch: # Manual trigger for testing
  schedule:
    - cron: '0 */6 * * *' # Run every 6 hours (optional)

permissions:
  contents: read

jobs:
  monitor-and-notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install GitHub CLI and Copilot CLI
        run: |
          # Authenticate GitHub CLI
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          
          # Install Copilot CLI
          curl -fsSL https://gh.io/copilot-install | bash

      - name: Install Copilot SDK
        run: pip install github-copilot-sdk

      - name: Run workflow monitoring script
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # Required by Copilot SDK
          PYTHONUNBUFFERED: 1  # Ensure real-time log output
        run: |
          # Add Copilot CLI to PATH
          export PATH="$HOME/.local/bin:$PATH"
          
          # Run the monitoring script
          echo "========== Starting workflow monitor =========="
          python -u scripts/summarize_workflows.py
          echo "========== Monitoring completed =========="
